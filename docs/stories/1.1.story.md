# Story 1.1: Create Employee Model and Database Schema

**Epic:** Employee Master Data Foundation
**Story ID:** 1.1
**Status:** Draft
**Created:** 2025-09-29
**Estimated Effort:** 4-6 hours

## User Story

As an HRIS system administrator,
I want a dedicated Employee model separate from User authentication,
So that I can manage comprehensive employee data independently from system access for PT Kimia Farma's HRIS needs.

## Story Description

This story establishes the foundational database schema and Eloquent models for the Employee Master Data system. It creates a separate Employee entity that links to but is independent from the existing User authentication system, enabling comprehensive employee data management for PT Kimia Farma's workforce across all divisions and subsidiaries.

## Acceptance Criteria

### AC1: Core Employee Table Created
- **Given** the need for comprehensive employee data management
- **When** I run the employee migration
- **Then** a complete employees table is created with all required HRIS fields:
  - Personal Information: employee_id, employee_number, full_name, preferred_name, birth_date, national_id, tax_id
  - Contact Information: email, phone, emergency_contact_name, emergency_contact_phone, address
  - Employment Information: employment_status, employment_type, hire_date, termination_date, photo_url
  - Organizational: division_id, job_position_id, manager_id (self-referencing)
  - System: user_id (nullable), created_at, updated_at, deleted_at

### AC2: Child Tables for Professional Information
- **Given** the need to track employee professional development
- **When** I run all related migrations
- **Then** child tables are created:
  - employee_education_history: institution_name, degree_level, field_of_study, graduation_year, gpa, is_verified
  - employee_certifications: certification_name, issuing_organization, issue_date, expiry_date, certification_number, is_active
  - employee_professional_licenses: license_name, license_number, issuing_authority, issue_date, expiry_date, license_status

### AC3: Proper Database Relationships and Constraints
- **Given** the need for data integrity
- **When** the schema is implemented
- **Then** proper foreign key relationships exist:
  - Employee → User (nullable, one-to-one)
  - Employee → Division (required, many-to-one)
  - Employee → JobPosition (required, many-to-one)
  - Employee → Employee as manager (nullable, many-to-one)
  - EmployeeEducation/Certification/License → Employee (cascade delete)

### AC4: Eloquent Models with Relationships
- **Given** the need for Laravel ORM integration
- **When** I access employee data through models
- **Then** all Eloquent relationships work correctly:
  - Employee model has proper belongsTo and hasMany relationships
  - Child models correctly reference Employee
  - Soft deletes implemented on Employee model
  - Model attributes are properly cast (dates, booleans, enums)

### AC5: Database Performance Optimization
- **Given** the need to handle 10,000+ employee records
- **When** the migrations are applied
- **Then** proper indexes are created for:
  - Frequently queried fields: employment_status, division_id, manager_id, email, employee_number, full_name
  - Foreign keys: user_id, division_id, job_position_id, manager_id
  - Child table relationships: employee_id on all child tables

### AC6: Test Data Infrastructure
- **Given** the need for development and testing
- **When** I run database seeders
- **Then** comprehensive test data is available:
  - Employee factory creates realistic employee records
  - Child table factories for education/certifications/licenses
  - PT Kimia Farma organizational structure seeded
  - Sample employees across divisions and job positions

## Dev Notes

### Previous Story Insights
This is the first story, no previous insights available.

### Data Models and Schema

**Employee Model Specifications** [Source: docs/architecture.md#Employee]
- Primary fields based on Indonesian employment law requirements
- Employee ID format: "KF2024001" (business identifier separate from database ID)
- Employment status enum: active, inactive, terminated, on_leave, probation, contract, suspended
- Employment type enum: permanent, contract, intern, consultant
- National ID (KTP) and Tax ID (NPWP) for Indonesian compliance
- Photo URL for employee identification

**Child Tables Design** [Source: docs/architecture.md#Database-Schema]
- education_history: institution_name, degree_level, field_of_study, graduation_year, gpa, is_verified
- certifications: certification_name, issuing_organization, issue_date, expiry_date, certification_number, is_active
- professional_licenses: license_name, license_number, issuing_authority, issue_date, expiry_date, license_status

**Relationship Specifications** [Source: docs/architecture.md#Employee]
- belongsTo User (nullable) - Authentication account link
- belongsTo Division - Organizational division assignment
- belongsTo JobPosition - Current job position
- belongsTo Employee as manager - Direct supervisor relationship
- hasMany EmployeeEducation/Certification/License - Professional development records

### File Locations and Structure

**Database Migrations** [Source: docs/architecture.md#Source-Tree]
- `database/migrations/2024_10_01_000001_create_divisions_table.php` (if not exists)
- `database/migrations/2024_10_01_000002_create_job_positions_table.php` (if not exists)
- `database/migrations/2024_10_01_000003_create_employees_table.php`
- `database/migrations/2024_10_01_000004_create_employee_education_history_table.php`
- `database/migrations/2024_10_01_000005_create_employee_certifications_table.php`
- `database/migrations/2024_10_01_000006_create_employee_professional_licenses_table.php`

**Eloquent Models** [Source: docs/architecture.md#Source-Tree]
- `app/Models/Employee.php` - Core employee model
- `app/Models/EmployeeEducationHistory.php` - Education history model
- `app/Models/EmployeeCertification.php` - Certification model
- `app/Models/EmployeeProfessionalLicense.php` - Professional license model

**Test Infrastructure** [Source: docs/architecture.md#Source-Tree]
- `database/factories/EmployeeFactory.php` - Employee test data factory
- `database/factories/EmployeeEducationHistoryFactory.php` - Education factory
- `database/factories/EmployeeCertificationFactory.php` - Certification factory
- `database/factories/EmployeeProfessionalLicenseFactory.php` - License factory
- `database/seeders/EmployeeSeeder.php` - Sample employee data with PT Kimia Farma structure

### Technology Stack and Patterns

**Database Technology** [Source: docs/architecture.md#Tech-Stack]
- PostgreSQL 14+ with Laravel Eloquent ORM 9.19
- Database transactions for multi-table operations
- Proper indexing for performance with 10,000+ records

**Laravel Patterns** [Source: docs/architecture.md#Architectural-and-Design-Patterns]
- Repository Pattern for data access abstraction
- Service Layer Pattern for business logic
- Clean Architecture with domain separation
- API Resource Pattern for response formatting

**Coding Standards** [Source: docs/architecture.md#Coding-Standards]
- PascalCase for Models: Employee, EmployeeEducationHistory
- snake_case for database tables: employees, employee_education_history
- Repository pattern enforcement - no direct Eloquent in controllers
- Database transactions required for multi-table operations

### Testing Requirements

**Unit Testing** [Source: docs/architecture.md#Test-Strategy]
- PHPUnit 9.5.10 framework with existing configuration
- Test all model relationships and validation rules
- Cover edge cases and constraint violations
- 80% minimum coverage for model classes

**Integration Testing** [Source: docs/architecture.md#Test-Strategy]
- Database interactions with PostgreSQL
- Laravel factories for realistic test scenarios
- Constraint validation and foreign key integrity
- Performance testing for large datasets

**Test Data Strategy** [Source: docs/architecture.md#Test-Data-Management]
- Laravel Model Factories with realistic PT Kimia Farma data patterns
- Database transactions with automatic rollback for test isolation
- JSON fixtures for complex organizational hierarchies
- Anonymized subset of PT Kimia Farma organizational structure

### Security and Compliance

**Data Protection** [Source: docs/architecture.md#Security]
- Encrypted database fields for sensitive PII (national_id, tax_id)
- Indonesian personal data protection compliance
- No sensitive data in logs or error messages
- Proper audit trail integration for employee data changes

**Input Validation** [Source: docs/architecture.md#Security]
- Employee personal data must use Indonesian format validation
- Whitelist approach for enum values (employment_status, employment_type)
- File upload validation for employee photos (type, size, malware scanning)

### Integration Points

**Existing System Integration** [Source: docs/brownfield-architecture.md]
- User model: Nullable one-to-one relationship (employee can exist without system access)
- Division model: Required relationship for organizational assignment
- JobPosition model: Required relationship for role assignment
- Audit trail: Extend existing audit system for employee data changes
- RBAC: Use existing permission system for employee data access

**Brownfield Considerations** [Source: docs/brownfield-architecture.md]
- Laravel 9.19 + React 18.3 existing architecture
- PostgreSQL with existing migrations for users, roles, permissions, audit trails
- Established patterns: Repository, Service, API Resources, Form Requests
- No changes to existing User authentication or RBAC systems

## Tasks / Subtasks

### Task 1: Create Core Employee Migration (AC: 1, 3, 5)
1.1. Generate migration file: `php artisan make:migration create_employees_table`
1.2. Define employees table schema with all required fields per architecture specification
1.3. Add foreign key constraints to existing User, Division, JobPosition tables
1.4. Implement self-referencing foreign key for manager relationship
1.5. Add database indexes for performance on frequently queried fields
1.6. Add soft deletes support with deleted_at timestamp
1.7. Include proper column constraints and default values

### Task 2: Create Child Tables Migrations (AC: 2, 3, 5)
2.1. Generate migration: `php artisan make:migration create_employee_education_history_table`
2.2. Generate migration: `php artisan make:migration create_employee_certifications_table`
2.3. Generate migration: `php artisan make:migration create_employee_professional_licenses_table`
2.4. Define child table schemas with proper foreign key relationships to employees
2.5. Add cascade delete constraints for data integrity
2.6. Add indexes on employee_id and expiry_date fields for performance
2.7. Include validation constraints for enum fields and required data

### Task 3: Implement Employee Eloquent Model (AC: 4)
3.1. Generate model: `php artisan make:model Employee`
3.2. Configure model attributes: fillable, hidden, casts, dates
3.3. Implement belongsTo relationships: user, division, jobPosition, manager
3.4. Implement hasMany relationships: education, certifications, licenses, subordinates
3.5. Add soft deletes trait and configuration
3.6. Implement custom accessors/mutators for employee_id generation
3.7. Add model validation rules and constraints

### Task 4: Implement Child Models (AC: 4)
4.1. Generate models: `EmployeeEducationHistory`, `EmployeeCertification`, `EmployeeProfessionalLicense`
4.2. Configure model attributes and relationships for each child model
4.3. Implement belongsTo Employee relationship with proper foreign keys
4.4. Add validation rules for each model's specific requirements
4.5. Implement date casting and enum handling where applicable
4.6. Add custom accessors for computed fields (e.g., certification expired status)

### Task 5: Create Model Factories (AC: 6)
5.1. Generate factories for Employee and all child models
5.2. Implement realistic data generation using Faker with Indonesian context
5.3. Create factory states for different employment statuses and types
5.4. Implement relationship factories for creating complete employee records
5.5. Add PT Kimia Farma specific data patterns (division codes, position titles)
5.6. Ensure factories support both individual and bulk data generation

### Task 6: Create Database Seeders (AC: 6)
6.1. Generate seeder: `php artisan make:seeder EmployeeSeeder`
6.2. Implement seeding for PT Kimia Farma organizational structure
6.3. Create sample employees across different divisions and job positions
6.4. Seed realistic education, certification, and license data
6.5. Implement manager-subordinate relationships in seeded data
6.6. Add command line options for different seeding scenarios

### Task 7: Unit Testing (All ACs)
7.1. Create test files: `EmployeeTest`, `EmployeeEducationHistoryTest`, etc.
7.2. Test model relationships and foreign key constraints
7.3. Test model validation rules and data casting
7.4. Test soft delete functionality and cascading deletes
7.5. Test factory data generation and relationship creation
7.6. Test database indexes and query performance
7.7. Achieve 80% minimum test coverage for all model classes

### Task 8: Integration Testing (All ACs)
8.1. Create feature test: `EmployeeSchemaIntegrationTest`
8.2. Test complete employee creation with child records
8.3. Test foreign key constraint violations and error handling
8.4. Test database migration rollback scenarios
8.5. Test seeder execution and data integrity
8.6. Test performance with large datasets (1000+ employee records)
8.7. Verify existing User/Division/JobPosition functionality unaffected

## Definition of Done

### Functional Requirements Complete
- ✅ All database migrations execute successfully without errors
- ✅ Employee model and child models implement all specified relationships
- ✅ Database constraints and indexes properly configured
- ✅ Model factories generate realistic test data
- ✅ Database seeders create sample PT Kimia Farma employee structure

### Quality Requirements Met
- ✅ Unit tests achieve 80% minimum coverage for all models
- ✅ Integration tests verify schema integrity and performance
- ✅ All tests pass in CI/CD pipeline
- ✅ Code follows Laravel coding standards and repository patterns
- ✅ Database performance optimized for 10,000+ employee records

### Integration Requirements Satisfied
- ✅ Employee-User relationship properly separated and working
- ✅ Integration with existing Division and JobPosition models validated
- ✅ No regression in existing User authentication or RBAC functionality
- ✅ Database schema is backward compatible
- ✅ Audit trail integration points identified and documented

### Documentation Updated
- ✅ Database schema documentation reflects new tables and relationships
- ✅ Model relationship documentation updated
- ✅ API documentation prepared for next story (endpoints TBD)
- ✅ Migration rollback procedures documented

## Risk Assessment

**Primary Risk:** Database schema complexity affecting existing system performance
**Mitigation:** Proper indexing strategy and gradual migration approach
**Rollback Plan:** Database migrations include proper down() methods for complete rollback

**Secondary Risk:** Foreign key constraint violations during development
**Mitigation:** Comprehensive testing of all relationship scenarios and constraint validation
**Monitoring:** Database constraint violation logging and alerting

## Next Story Dependencies

This story provides the foundation for:
- **Story 1.2:** Implement Employee CRUD API Endpoints (depends on models and database schema)
- **Story 1.3:** Build Employee Management Frontend Interface (depends on API endpoints)

The database schema and models created in this story are required before any API or frontend development can begin.

---

*This story was created using BMad create-next-story methodology on 2025-09-29 for KAEF HRIS Employee Master Data Epic 1.1.*