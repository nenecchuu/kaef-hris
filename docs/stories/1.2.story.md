# Story 1.2: Implementasi API Endpoint CRUD Karyawan

**Epic:** Employee Master Data Foundation
**Story ID:** 1.2
**Status:** Completed
**Created:** 2025-09-29
**Estimated Effort:** 6-8 hours

## User Story

Sebagai administrator sistem HRIS,
Saya ingin API endpoint lengkap untuk operasi CRUD data karyawan,
Sehingga aplikasi frontend dapat mengakses dan mengelola data karyawan PT Kimia Farma dengan aman dan efisien.

## Story Description

**BACKEND ONLY** - Story ini membangun API endpoint RESTful lengkap untuk sistem Employee Master Data yang mendukung operasi Create, Read, Update, dan Delete untuk data karyawan. API ini menyediakan antarmuka backend yang aman dan terstruktur untuk frontend aplikasi HRIS PT Kimia Farma, dengan validasi komprehensif, autentikasi, dan otorisasi yang sesuai dengan kebutuhan brownfield integration.

**Scope:** This story focuses EXCLUSIVELY on backend API implementation. No frontend/UI components are included. Frontend development akan dilakukan di Story 1.3.

**Catatan Teknis:**
- Semua kode (entity, variable, function names) ditulis dalam Bahasa Inggris mengikuti standar Laravel
- Semua pesan user-facing (validation messages, API responses, error messages) ditulis dalam Bahasa Indonesia
- Database field names tetap dalam Bahasa Inggris sesuai konvensi Laravel

## Acceptance Criteria

### AC1: API Endpoint Daftar Karyawan dengan Pagination dan Filter
- **Given** kebutuhan untuk melihat daftar karyawan dengan performa optimal
- **When** saya melakukan GET request ke `/api/karyawan`
- **Then** API mengembalikan response dengan:
  - Pagination menggunakan Laravel standard (per_page, current_page, total, last_page)
  - Filter berdasarkan: status_kepegawaian, divisi_id, jabatan_id, nama_lengkap (pencarian)
  - Sorting berdasarkan: nama_lengkap, tanggal_masuk, nomor_karyawan
  - Data karyawan mencakup: informasi dasar, divisi, jabatan, manager
  - Response format JSON sesuai standard API Resource Laravel

### AC2: API Endpoint Detail Karyawan Lengkap
- **Given** kebutuhan untuk melihat detail lengkap seorang karyawan
- **When** saya melakukan GET request ke `/api/karyawan/{employee_id}`
- **Then** API mengembalikan:
  - Data karyawan lengkap termasuk relasi: divisi, jabatan, manager, bawahan
  - Riwayat pendidikan (employee_education_history)
  - Sertifikasi (employee_certifications)
  - Lisensi profesional (employee_professional_licenses)
  - Error 404 dengan pesan bahasa Indonesia jika karyawan tidak ditemukan
  - Caching untuk optimasi performa

### AC3: API Endpoint Pembuatan Karyawan Baru
- **Given** kebutuhan untuk menambah karyawan baru
- **When** saya melakukan POST request ke `/api/karyawan`
- **Then** API melakukan:
  - Validasi lengkap semua field wajib dan format data
  - Validasi unique untuk nomor_karyawan, nik, npwp, email
  - Generate nomor karyawan otomatis jika tidak disediakan (format: "KF2025XXX")
  - Validasi format Indonesia untuk NIK (16 digit) dan NPWP (15 digit)
  - Simpan data karyawan dan data terkait (pendidikan, sertifikasi, lisensi) dalam database transaction
  - Response 201 dengan data karyawan yang baru dibuat
  - Error response dengan pesan validasi bahasa Indonesia

### AC4: API Endpoint Update Data Karyawan
- **Given** kebutuhan untuk mengubah data karyawan
- **When** saya melakukan PUT/PATCH request ke `/api/karyawan/{employee_id}`
- **Then** API melakukan:
  - Validasi field yang diubah sesuai aturan bisnis
  - Validasi unique fields kecuali untuk record yang sedang diupdate
  - Update data karyawan dengan database transaction
  - Support partial update untuk PATCH request
  - Audit trail untuk perubahan data sensitif
  - Response dengan data karyawan yang telah diupdate
  - Validasi authorization - hanya user yang berwenang dapat mengubah data

### AC5: API Endpoint Soft Delete Karyawan
- **Given** kebutuhan untuk menon-aktifkan karyawan tanpa menghapus data
- **When** saya melakukan DELETE request ke `/api/karyawan/{employee_id}`
- **Then** API melakukan:
  - Soft delete karyawan (update deleted_at timestamp)
  - Update status_kepegawaian menjadi "terminated"
  - Validasi bahwa karyawan bukan manager aktif dari karyawan lain
  - Audit trail untuk pencatatan penghapusan
  - Response 204 No Content untuk sukses
  - Error response jika karyawan masih memiliki bawahan aktif

### AC6: API Endpoint Data Pendidikan, Sertifikasi, dan Lisensi
- **Given** kebutuhan untuk mengelola data profesional karyawan
- **When** saya melakukan operasi CRUD pada endpoint terkait
- **Then** tersedia endpoint:
  - `/api/karyawan/{employee_id}/pendidikan` - CRUD riwayat pendidikan
  - `/api/karyawan/{employee_id}/sertifikasi` - CRUD sertifikasi
  - `/api/karyawan/{employee_id}/lisensi` - CRUD lisensi profesional
  - Validasi relasi dengan karyawan yang valid
  - Validasi format tanggal Indonesia dan periode validitas
  - Support upload dokumen untuk sertifikasi dan lisensi

### AC7: Validasi dan Error Handling Komprehensif
- **Given** kebutuhan untuk user experience yang baik
- **When** terjadi error atau validasi gagal
- **Then** API mengembalikan:
  - HTTP status code yang sesuai (400, 401, 403, 404, 422, 500)
  - Error message dalam bahasa Indonesia
  - Detail validasi error untuk setiap field yang gagal
  - Consistent error response format menggunakan Laravel API Resources
  - Logging error untuk monitoring dan debugging

### AC8: Authentication dan Authorization
- **Given** kebutuhan keamanan data karyawan
- **When** mengakses API endpoint karyawan
- **Then** sistem memvalidasi:
  - Bearer token authentication menggunakan sistem existing
  - Role-based access control untuk operasi CRUD
  - Permission level: hr_admin (full access), hr_staff (read/update), manager (read own team)
  - Rate limiting untuk mencegah abuse API
  - CORS configuration untuk frontend access

## Dev Notes

### Previous Story Insights
Story 1.1 berhasil membuat foundation model Employee dan database schema. Insights:
- Database schema Employee dengan relasi ke User, Division, JobPosition sudah tersedia
- Model Eloquent dengan relationships sudah terimplementasi
- Factories dan seeders untuk test data sudah siap
- Integration dengan sistem authentication existing berhasil

### API Design dan Response Format

**Standard API Response Format** [Source: docs/architecture.md#API-Design]
```json
{
  "status": "success|error",
  "message": "Pesan dalam bahasa Indonesia",
  "data": {
    // Data payload
  },
  "meta": {
    // Pagination dan metadata
  },
  "errors": {
    // Validation errors jika ada
  }
}
```

**Employee API Resource Fields** [Source: Story 1.1 - Employee Model]
```json
{
  "id": "integer",
  "nomor_karyawan": "string (KF2025XXX)",
  "nama_lengkap": "string",
  "nama_panggilan": "string",
  "email": "string",
  "telepon": "string",
  "nik": "string (16 digit)",
  "npwp": "string (15 digit)",
  "tanggal_lahir": "date (YYYY-MM-DD)",
  "tanggal_masuk": "date (YYYY-MM-DD)",
  "tanggal_keluar": "date|null",
  "status_kepegawaian": "enum",
  "jenis_kepegawaian": "enum",
  "alamat": "text",
  "foto_url": "string|null",
  "divisi": {
    "id": "integer",
    "nama": "string",
    "kode": "string"
  },
  "jabatan": {
    "id": "integer",
    "nama": "string",
    "level": "integer"
  },
  "manager": {
    "id": "integer",
    "nama_lengkap": "string",
    "nomor_karyawan": "string"
  }
}
```

**Indonesian Validation Messages** [Source: Indonesian HRIS Compliance]
- "Nomor karyawan sudah digunakan"
- "NIK harus 16 digit angka"
- "NPWP harus 15 digit angka dengan format yang benar"
- "Tanggal lahir tidak boleh di masa depan"
- "Email sudah terdaftar untuk karyawan lain"
- "Divisi wajib dipilih"
- "Jabatan wajib dipilih"

### File Locations dan Structure

**API Controllers** [Source: docs/architecture.md#Source-Tree]
- `app/Http/Controllers/Api/KaryawanController.php` - Main employee CRUD controller
- `app/Http/Controllers/Api/KaryawanPendidikanController.php` - Education management
- `app/Http/Controllers/Api/KaryawanSertifikasiController.php` - Certification management
- `app/Http/Controllers/Api/KaryawanLisensiController.php` - License management

**Form Request Validation** [Source: docs/architecture.md#Source-Tree]
- `app/Http/Requests/StoreKaryawanRequest.php` - Validation untuk create employee
- `app/Http/Requests/UpdateKaryawanRequest.php` - Validation untuk update employee
- `app/Http/Requests/StoreKaryawanPendidikanRequest.php` - Education validation
- `app/Http/Requests/StoreKaryawanSertifikasiRequest.php` - Certification validation
- `app/Http/Requests/StoreKaryawanLisensiRequest.php` - License validation

**API Resources** [Source: docs/architecture.md#Source-Tree]
- `app/Http/Resources/KaryawanResource.php` - Employee API resource
- `app/Http/Resources/KaryawanDetailResource.php` - Detailed employee resource
- `app/Http/Resources/KaryawanCollectionResource.php` - Employee collection
- `app/Http/Resources/KaryawanPendidikanResource.php` - Education resource
- `app/Http/Resources/KaryawanSertifikasiResource.php` - Certification resource
- `app/Http/Resources/KaryawanLisensiResource.php` - License resource

**Repository Pattern** [Source: docs/architecture.md#Architectural-and-Design-Patterns]
- `app/Repositories/EmployeeRepository.php` - Employee data access layer
- `app/Repositories/Interfaces/EmployeeRepositoryInterface.php` - Repository contract
- `app/Services/EmployeeService.php` - Business logic layer
- `app/Services/Interfaces/EmployeeServiceInterface.php` - Service contract

**API Routes** [Source: docs/architecture.md#Source-Tree]
- `routes/api.php` - API route definitions dengan middleware authentication

### Technology Stack dan Patterns

**Laravel API Features** [Source: docs/architecture.md#Tech-Stack]
- Laravel 9.19 API Resources untuk response formatting
- Form Request Validation dengan Indonesian language support
- Repository Pattern untuk data abstraction
- Service Layer untuk business logic
- Database transactions untuk data consistency

**Authentication Integration** [Source: docs/brownfield-architecture.md]
- Laravel Sanctum existing system untuk API authentication
- Role-Based Access Control existing permissions
- Middleware integration untuk route protection
- Rate limiting menggunakan Laravel throttle

**Validation Patterns** [Source: docs/architecture.md#Security]
- Indonesian format validation (NIK, NPWP, phone numbers)
- Custom validation rules untuk business logic
- File upload validation untuk employee photos
- Database unique constraints validation

### Testing Requirements

**API Testing Strategy** [Source: docs/architecture.md#Test-Strategy]
- Feature tests untuk semua API endpoints menggunakan PHPUnit
- Test authentication dan authorization scenarios
- Test validation rules dan error responses
- Test pagination dan filtering functionality
- Test database transactions dan rollback scenarios
- Performance testing untuk large datasets

**Test Data Management** [Source: docs/architecture.md#Test-Data-Management]
- Gunakan Employee factories dari Story 1.1
- Database transactions untuk test isolation
- Mock external services (file uploads, notifications)
- Test dengan data PT Kimia Farma realistic scenarios

### Security dan Compliance

**Data Protection** [Source: docs/architecture.md#Security]
- PII encryption untuk NIK, NPWP, dan sensitive data
- Audit logging untuk semua data changes
- Input sanitization dan XSS protection
- SQL injection protection melalui Eloquent ORM
- File upload security validation

**Indonesian Compliance** [Source: Indonesian HRIS Requirements]
- NIK validation sesuai format Indonesia
- NPWP validation dengan checksum
- Tanggal format Indonesia (DD-MM-YYYY untuk display)
- Indonesian language error messages
- Employment law compliance untuk status karyawan

### Integration Points

**Existing System Integration** [Source: docs/brownfield-architecture.md]
- User authentication system untuk API access
- RBAC permissions untuk endpoint authorization
- Division dan JobPosition models untuk dropdowns
- Audit trail system untuk data change tracking
- File storage system untuk employee photos

**Frontend Integration Preparation** [Source: Story 1.3 Dependencies]
- CORS configuration untuk React frontend
- Consistent API response format
- Comprehensive error handling untuk UX
- API documentation generation menggunakan OpenAPI/Swagger

## Tasks / Subtasks

### Task 1: Setup API Routes dan Middleware (AC: 8)
1.1. Define API routes dalam `routes/api.php` untuk semua employee endpoints
1.2. Apply authentication middleware menggunakan existing Sanctum system
1.3. Setup RBAC middleware untuk authorization checks
1.4. Configure rate limiting untuk API endpoints
1.5. Setup CORS configuration untuk frontend access
1.6. Add API versioning support dengan prefix `/api/v1`

### Task 2: Implement Employee Repository Pattern (AC: 1, 2, 4, 5)
2.1. Create `EmployeeRepositoryInterface` dengan method definitions
2.2. Implement `EmployeeRepository` dengan Eloquent operations
2.3. Add methods untuk: index dengan pagination/filtering, show, store, update, destroy
2.4. Implement query optimization dengan eager loading relationships
2.5. Add search functionality dengan full-text search capabilities
2.6. Register repository binding dalam Service Provider

### Task 3: Create Employee Service Layer (AC: 3, 4, 5)
3.1. Create `EmployeeServiceInterface` untuk business logic contract
3.2. Implement `EmployeeService` dengan business rules
3.3. Add employee number generation logic (KF2025XXX format)
3.4. Implement validation business rules (manager hierarchy, etc.)
3.5. Add audit trail integration untuk data changes
3.6. Handle file upload logic untuk employee photos
3.7. Implement soft delete dengan status update logic

### Task 4: Create Form Request Validation Classes (AC: 3, 7)
4.1. Generate `StoreKaryawanRequest` dengan validation rules
4.2. Generate `UpdateKaryawanRequest` dengan conditional validation
4.3. Add Indonesian validation messages dalam language files
4.4. Implement custom validation rules untuk NIK dan NPWP format
4.5. Add unique validation dengan ignore rules untuk updates
4.6. Implement authorization methods dalam form requests
4.7. Add validation untuk nested data (education, certifications, licenses)

### Task 5: Implement API Resource Classes (AC: 1, 2)
5.1. Create `KaryawanResource` untuk basic employee data
5.2. Create `KaryawanDetailResource` untuk detailed view dengan relationships
5.3. Create `KaryawanCollectionResource` untuk paginated lists
5.4. Implement conditional loading berdasarkan user permissions
5.5. Add computed fields (age, tenure, etc.) dalam resources
5.6. Optimize resource loading untuk performance
5.7. Add meta information untuk pagination dan filtering

### Task 6: Build Main Employee Controller (AC: 1, 2, 3, 4, 5)
6.1. Generate `KaryawanController` dengan resource methods
6.2. Implement `index()` method dengan pagination, filtering, dan searching
6.3. Implement `show()` method dengan detailed employee information
6.4. Implement `store()` method dengan database transactions
6.5. Implement `update()` method dengan partial update support
6.6. Implement `destroy()` method dengan soft delete logic
6.7. Add proper error handling dan logging

### Task 7: Implement Child Resource Controllers (AC: 6)
7.1. Generate controllers untuk education, certification, dan license management
7.2. Implement CRUD operations untuk each child resource
7.3. Add parent-child validation (employee must exist)
7.4. Implement file upload untuk certification/license documents
7.5. Add expiry date validation dan notification logic
7.6. Ensure proper authorization untuk child resource access

### Task 8: API Testing Implementation (AC: 1-8)
8.1. Create feature test `KaryawanApiTest` untuk main CRUD operations
8.2. Test pagination, filtering, dan search functionality
8.3. Test validation rules dan error responses
8.4. Test authentication dan authorization scenarios
8.5. Test file upload functionality
8.6. Create tests untuk child resource controllers
8.7. Performance testing untuk large datasets
8.8. Test database transaction rollback scenarios

### Task 9: Error Handling dan Logging (AC: 7)
9.1. Implement global exception handler untuk API responses
9.2. Create consistent error response format
9.3. Add Indonesian error messages dalam language files
9.4. Implement comprehensive logging untuk API operations
9.5. Add monitoring hooks untuk performance tracking
9.6. Setup alert notifications untuk critical errors

### Task 10: API Documentation (Integration Preparation)
10.1. Generate OpenAPI/Swagger documentation
10.2. Document all endpoints dengan request/response examples
10.3. Add authentication documentation
10.4. Create Postman collection untuk testing
10.5. Document error codes dan troubleshooting guide
10.6. Add rate limiting documentation

## Definition of Done

### Functional Requirements Complete
- ✅ Semua API endpoints employee CRUD berfungsi dengan benar
- ✅ Pagination, filtering, dan searching berfungsi optimal
- ✅ Validation comprehensive dengan pesan bahasa Indonesia
- ✅ Authentication dan authorization terintegrasi dengan sistem existing
- ✅ File upload untuk foto karyawan berfungsi dengan aman
- ✅ Child resources (education, certification, license) fully functional

### Quality Requirements Met
- ✅ Feature tests mencapai 90% minimum coverage untuk API controllers
- ✅ Performance testing menunjukkan response time < 200ms untuk single record
- ✅ Load testing menunjukkan API dapat handle 1000+ concurrent requests
- ✅ Security testing validasi authentication, authorization, dan input sanitization
- ✅ API documentation lengkap dan akurat

### Integration Requirements Satisfied
- ✅ Integration dengan existing User authentication system berhasil
- ✅ RBAC permissions berfungsi untuk semua endpoints
- ✅ Database transactions ensure data consistency
- ✅ Error handling terintegrasi dengan logging system
- ✅ Frontend CORS configuration ready untuk React integration

### Business Requirements Fulfilled
- ✅ Indonesian format validation (NIK, NPWP) implemented
- ✅ PT Kimia Farma business rules enforced dalam API logic
- ✅ Audit trail untuk compliance dan data tracking
- ✅ Employee hierarchy validation (manager relationships)
- ✅ Soft delete preserves data integrity

### Documentation Updated
- ✅ API documentation generated dengan OpenAPI specification
- ✅ Postman collection created untuk testing dan integration
- ✅ Database schema documentation updated dengan API access patterns
- ✅ Security documentation updated dengan API authentication patterns
- ✅ Troubleshooting guide untuk common API issues

## Risk Assessment

**Primary Risk:** API performance degradation dengan large employee datasets
**Mitigation:** Database query optimization, caching strategy, pagination limits
**Rollback Plan:** API versioning allows reverting ke previous version jika needed

**Secondary Risk:** Authentication integration issues dengan existing system
**Mitigation:** Comprehensive testing dengan existing User dan RBAC system
**Monitoring:** API authentication failure rate monitoring dan alerts

**Data Security Risk:** Unauthorized access ke sensitive employee data
**Mitigation:** Multi-layer authorization, audit logging, input validation
**Compliance:** Regular security audit dan penetration testing

## Next Story Dependencies

**IMPORTANT:** Story 1.2 is BACKEND API ONLY. No frontend/UI components are created in this story.

This story provides the backend API foundation for:
- **Story 1.3:** Build Employee Management Frontend Interface (FRONTEND - depends on Story 1.2 API endpoints)
- **Story 1.4:** Implement Advanced Employee Search and Reporting (extends API functionality)

**Implementation Sequence:**
1. Story 1.2 (This Story): Backend API endpoints ← YOU ARE HERE
2. Story 1.3 (Next): Frontend React components using these APIs
3. Story 1.4 (Future): Advanced features building on both

The API endpoints created dalam story ini are required before frontend development dapat dimulai. The comprehensive validation dan business rules implemented here will ensure data consistency across all future integrations.

---

*This story was created using BMad create-next-story methodology on 2025-09-29 for KAEF HRIS Employee Master Data Epic 1.2.*